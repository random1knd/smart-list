modules:
  # SQL database module - enables Forge SQL for the app
  sql:
    - key: main
      engine: mysql

  # Function modules
  function:
    # Backend resolver for all note and notification operations
    - key: notes-resolver
      handler: index.handler
    
    # Scheduled function for checking and sending notifications
    - key: notification-scheduler
      handler: scheduled.handler
    
    # JQL function for searching issues with notes
    - key: jql-notes-function
      handler: jqlHandler.handler
    
    # JQL function for note count filtering
    - key: jql-notes-count
      handler: jqlHandler.countHandler
    
    # JQL function for notes after date
    - key: jql-notes-after
      handler: jqlHandler.afterHandler
    
    # JQL function for notes before date
    - key: jql-notes-before
      handler: jqlHandler.beforeHandler
    
    # JQL function for notes in date range
    - key: jql-notes-range
      handler: jqlHandler.rangeHandler
  
  # Scheduled trigger - runs every 5 minutes to check for deadline notifications
  scheduledTrigger:
    - key: notification-check-trigger
      function: notification-scheduler
      interval: fiveMinute

  # Issue Panel module - main UI for managing private notes
  jira:issuePanel:
    - key: private-notes-panel
      resource: main
      resolver:
        function: notes-resolver
      viewportSize: large
      title: Private Notes
      icon: https://developer.atlassian.com/platform/forge/images/issue-panel-icon.svg
  
  # Issue Activity module - shows public note activities in the activity panel
  jira:issueActivity:
    - key: notes-activity
      resource: activity
      resolver:
        function: notes-resolver
      title: Notes Activity

  # JQL Functions - search for issues with notes
  jira:jqlFunction:
    # Basic function - find all issues with notes
    - key: issues-with-notes-v2
      name: issuesWithNotes
      description: Find issues that have private notes
      arguments: []
      types:
        - issue
      operators:
        - "in"
        - "not in"
      function: jql-notes-function
    
    # Count-based function - find issues with specific note counts
    - key: issues-with-notes-count
      name: issuesWithNotesCount
      description: Find issues based on note count (e.g., ">", 3 for more than 3 notes)
      arguments:
        - name: operator
          description: Comparison operator (">", "<", ">=", "<=", "=")
          required: true
        - name: count
          description: Number to compare against
          required: true
      types:
        - issue
      operators:
        - "in"
        - "not in"
      function: jql-notes-count
    
    # Date-based function - notes after a date
    - key: issues-with-notes-after
      name: issuesWithNotesAfter
      description: Find issues with notes created after a specific date (YYYY-MM-DD)
      arguments:
        - name: date
          description: Date in YYYY-MM-DD format
          required: true
      types:
        - issue
      operators:
        - "in"
        - "not in"
      function: jql-notes-after
    
    # Date-based function - notes before a date
    - key: issues-with-notes-before
      name: issuesWithNotesBefore
      description: Find issues with notes created before a specific date (YYYY-MM-DD)
      arguments:
        - name: date
          description: Date in YYYY-MM-DD format
          required: true
      types:
        - issue
      operators:
        - "in"
        - "not in"
      function: jql-notes-before
    
    # Date-based function - notes within a date range
    - key: issues-with-notes-in-range
      name: issuesWithNotesInDateRange
      description: Find issues with notes created within a date range (YYYY-MM-DD, YYYY-MM-DD)
      arguments:
        - name: startDate
          description: Start date in YYYY-MM-DD format
          required: true
        - name: endDate
          description: End date in YYYY-MM-DD format
          required: true
      types:
        - issue
      operators:
        - "in"
        - "not in"
      function: jql-notes-range


resources:
  - key: main
    path: static/notes/build
    tunnel:
      port: 3000
  - key: activity
    path: static/activity-panel/build
    tunnel:
      port: 3001
permissions:
  content:
    styles:
      - 'unsafe-inline'
  scopes:
    - read:jira-work
    - write:jira-work
    - read:jira-user
    - storage:app

app:
  runtime:
    name: nodejs22.x
    memoryMB: 512
    architecture: arm64
  id: ari:cloud:ecosystem::app/45ba455d-cec2-4acf-a5b1-fa70213eefc4
